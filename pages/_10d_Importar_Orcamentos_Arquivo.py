# pages/Importar_Orcamentos_Arquivo.py
import io
from datetime import datetime, date
import pandas as pd
import streamlit as st
from sqlmodel import select

from app.db import get_session, Client, Quote, QuoteItem  # usa os teus modelos

# Sidebar (import robusto)
try:
    from app.sidebar import show_sidebar
except Exception:
    import sys
    from pathlib import Path
    ROOT = Path(__file__).resolve().parents[1]
    if str(ROOT) not in sys.path:
        sys.path.insert(0, str(ROOT))
    from app.sidebar import show_sidebar
show_sidebar()

st.title("üì• Importar Or√ßamentos Antigos ‚Üí Arquivo (BD)")

# ===== Helpers de leitura (CSV sempre, Excel se openpyxl existir) =====
def read_table(uploaded_file) -> pd.DataFrame:
    name = uploaded_file.name.lower()
    data = uploaded_file.read()
    bio = io.BytesIO(data)
    try_xlsx = name.endswith(".xlsx") or name.endswith(".xls")
    if try_xlsx:
        try:
            import openpyxl  # noqa: F401
            return pd.read_excel(bio).fillna("")
        except Exception:
            st.warning("N√£o consegui ler Excel (openpyxl n√£o instalado). Vou tentar CSV.")
    # CSV: separador autom√°tico
    text = data.decode("utf-8", errors="ignore")
    sep = ";" if text.count(";") > text.count(",") else ","
    return pd.read_csv(io.StringIO(text), sep=sep).fillna("")

def parse_date(val):
    if isinstance(val, (datetime, date)):
        return datetime(val.year, val.month, val.day)
    s = str(val).strip()
    if not s:
        return None
    for fmt in ("%Y-%m-%d", "%d/%m/%Y", "%Y/%m/%d", "%d-%m-%Y"):
        try:
            dt = datetime.strptime(s, fmt)
            return datetime(dt.year, dt.month, dt.day)
        except Exception:
            pass
    return None

def to_float(v, default=0.0):
    try:
        if isinstance(v, str):
            v = v.replace("‚Ç¨", "").replace(",", ".").strip()
        return float(v)
    except Exception:
        return default


import re

_num_rx = re.compile(r"\D+")

# ===== Normaliza√ß√£o autom√°tica de cabe√ßalhos (ajuda no mapeamento) =====
# Mapas separados para Or√ßamentos e Itens, para evitar colis√µes de nomes
_alias_map_q = {
    "numero": ["numero","n¬∫","n¬∞","num","nr","n","no","n.¬∫","n.o","orcamento","n_orcamento","n orcamento","n¬∫ or√ßamento","n orc","numero orcamento","n√∫mero"],
    "data": ["data","data or√ßamento","data_orc","emissao","data emissao","emiss√£o","data criacao","data cria√ß√£o"],
    "cliente_numero": ["cliente n¬∫","cliente_numero","n¬∫ cliente","cod cliente","id cliente","codigo cliente","c√≥d cliente"],
    "cliente_nome": ["cliente","cliente nome","nome cliente","cliente_nome"],
    "estado": ["estado","status","situa√ß√£o","situacao"],
    "lingua": ["lingua","idioma","l√≠ngua"],
    "descricao": ["descricao","descri√ß√£o","descr","descri√ß√£o do trabalho","descricao do trabalho"],
    "observ": ["observ","observacoes","observa√ß√µes","obs","notas","observacoes internas","observa√ß√µes internas"],
    "desconto_total": ["desconto","desconto total","desconto_total"],
    "iva_percent": ["iva","iva %","iva_percent","taxa iva","taxa de iva"],
    "data_entrega": ["data entrega","entrega","data_entrega","data de entrega"],
    "total_final": ["total","total final","valor final","total_final","total cliente"],
    "total_cost": ["custo total","custo_total","custos","total custos","total de custos","custo or√ßamento","custo orcamento"],
    "aprovacao": ["aprovacao","aprovado","aprov.","aprov","foi aprovado","resultado","status aprovacao","estado aprovacao", "aprova√ß√£o"],
    "data_aprovacao": [
        "data aprova√ß√£o", "data aprovacao", "aprovado em", "data de aprova√ß√£o", "data de aprovacao", "aprov em"
    ],
}

_alias_map_i = {
    "quote_id": ["id or√ßamento","id orcamento","orcamento id","quote id","id_quote","quote_id"],
    "quote_numero": ["n¬∫ or√ßamento","numero or√ßamento","num or√ßamento","n orcamento","numero orcamento","orcamento","or√ßamento","n orc","n¬∫ orc","orc n¬∫","orc no","orc n¬∞"],
    "tipo_item": ["tipo","tipo item","tipo_item","material/servico","material/servi√ßo"],
    "code": ["codigo","c√≥digo","ref","referencia","refer√™ncia","sku","code","c√≥d"],
    "categoria": ["categoria","fam√≠lia","familia","grupo","sec√ß√£o","seccao","se√ß√£o"],
    "unidade": ["unidade","un.","unid","un","uni","ud"],
    "largura_cm": ["largura","larg (cm)","largura (cm)","larg_cm","largura_cm","larg"],
    "altura_cm": ["altura","alt (cm)","altura (cm)","alt_cm","altura_cm","alt"],
    "quantidade": ["quantidade","qtd","quant","qtde","qte","qtd."],
    "preco_unit": ["preco","pre√ßo","preco unitario","pre√ßo unit√°rio","pv unit","p.u.","pvu","valor unit","valor unit√°rio"],
    "percent_uso": ["% uso","percent uso","%", "% utilizado","percentagem uso","percentual uso"],
    "desconto_item": ["desconto item","desconto linha","desc linha","desc item","desconto","desc"],
    "nome_pt": ["nome","designa√ß√£o","designacao","descricao item","descri√ß√£o item","titulo","t√≠tulo"],
}

def _clean_hdr(h: str) -> str:
    return str(h or "").strip().lower().replace("\n"," ").replace("\t"," ").replace("  "," ")

def _normalize_cols_with_alias(df: pd.DataFrame, alias_map: dict) -> pd.DataFrame:
    cols = list(df.columns)
    mapped = {}
    used = set()
    for c in cols:
        key = _clean_hdr(c)
        target = None
        for canon, variants in alias_map.items():
            if key in variants:
                target = canon
                break
        if target is None:
            mapped[c] = c
            continue
        # evitar colis√µes: se j√° existir essa coluna can√≥nica no DF, n√£o renomear
        if target in used or target in cols:
            mapped[c] = c
        else:
            mapped[c] = target
            used.add(target)
    try:
        return df.rename(columns=mapped)
    except Exception:
        return df

def normalize_cols_quotes(df: pd.DataFrame) -> pd.DataFrame:
    return _normalize_cols_with_alias(df, _alias_map_q)

def normalize_cols_items(df: pd.DataFrame) -> pd.DataFrame:
    return _normalize_cols_with_alias(df, _alias_map_i)

def normalize_num_with_year(raw_num: str | int | float, dt: datetime | None, entrega_dt: datetime | None) -> str:
    """Devolve n√∫mero no formato YY####.
    - Se j√° vier no formato YY####, respeita-o.
    - Caso contr√°rio, usa o ano de `dt` (ou `entrega_dt`, sen√£o ano atual) e o n√∫mero limpo, zero-padded a 4.
    """
    s = str(raw_num or "").strip()
    if not s:
        return ""
    # se j√° estiver no formato 6 d√≠gitos (YY + 4 d√≠gitos), mant√©m
    if s.isdigit() and len(s) == 6:
        return s
    # limpar para s√≥ d√≠gitos
    digits = _num_rx.sub("", s)
    if not digits.isdigit():
        return ""  # n√£o conseguimos normalizar
    try:
        base_n = int(digits)
    except Exception:
        return ""
    if dt:
        yy = f"{dt.year % 100:02d}"
    elif entrega_dt:
        yy = f"{entrega_dt.year % 100:02d}"
    else:
        yy = datetime.utcnow().strftime("%y")
    return f"{yy}{base_n:04d}"

# ===== Upload dos ficheiros =====
col_up1, col_up2 = st.columns(2)
with col_up1:
    f_quotes = st.file_uploader("Ficheiro de OR√áAMENTOS (obrigat√≥rio)", type=["csv","xlsx"])
with col_up2:
    f_items = st.file_uploader("Ficheiro de ITENS (opcional)", type=["csv","xlsx"])

if not f_quotes:
    st.info("Carrega pelo menos o ficheiro de **Or√ßamentos**.")
    st.stop()

df_q = normalize_cols_quotes(read_table(f_quotes))
df_i = normalize_cols_items(read_table(f_items)) if f_items else pd.DataFrame()

st.subheader("Pr√©-visualiza√ß√£o")
st.write("Or√ßamentos:", df_q.shape, "linhas")
st.dataframe(df_q.head(10), use_container_width=True)
if not df_i.empty:
    st.write("Itens:", df_i.shape, "linhas")
    st.dataframe(df_i.head(10), use_container_width=True)

# ===== Mapeamento de colunas =====
st.markdown("### Mapeamento de colunas (Or√ßamentos)")

def sb(label, options, pref=None, key=None):
    idx = 0
    if pref and pref in options:
        idx = options.index(pref)
    return st.selectbox(label, options, index=idx, key=key)

cols_q = ["‚Äî"] + list(df_q.columns)
m_q = {}
c1, c2, c3 = st.columns(3)
with c1:
    m_q["numero"]         = sb("N√∫mero do or√ßamento", cols_q, key="q_numero")
    m_q["data"]           = sb("Data do or√ßamento", cols_q, key="q_data")
    m_q["cliente_numero"] = sb("Cliente N¬∫", cols_q, key="q_cli_num")
    m_q["cliente_nome"]   = sb("Cliente Nome", cols_q, key="q_cli_nome")
with c2:
    m_q["estado"]         = sb("Estado (ARQUIVADO/ENTREGUE/REJEITADO‚Ä¶)", cols_q, key="q_estado")
    m_q["lingua"]         = sb("L√≠ngua (PT/EN/FR)", cols_q, key="q_lang")
    m_q["descricao"]      = sb("Descri√ß√£o", cols_q, key="q_desc")
    m_q["observ"]         = sb("Observa√ß√µes internas", cols_q, key="q_obs")
with c3:
    m_q["desconto_total"] = sb("Desconto total ‚Ç¨", cols_q, key="q_desc_total")
    m_q["iva_percent"]    = sb("IVA %", cols_q, key="q_iva")
    m_q["data_entrega"]   = sb("Data de entrega", cols_q, key="q_entrega")
    m_q["total_final"]    = sb("Total final ‚Ç¨ (opcional)", cols_q, key="q_total")

# Campos adicionais (opcionais) para gravar no Quote
c7, c8, c9 = st.columns(3)
with c7:
    m_q["total_mat_cost"] = sb("Custo materiais ‚Ç¨ (opcional)", cols_q, key="q_mat_cost")
    m_q["total_srv_cost"] = sb("Custo servi√ßos ‚Ç¨ (opcional)", cols_q, key="q_srv_cost")
with c8:
    m_q["profit"]      = sb("Lucro ‚Ç¨ (opcional)", cols_q, key="q_profit")
    m_q["expense_pct"] = sb("% gastos (opcional)", cols_q, key="q_expense_pct")
    m_q["aprovacao"]  = sb("Aprova√ß√£o (SIM/N√ÉO) (opcional)", cols_q, key="q_aprov")
with c9:
    m_q["data_conclusao"] = sb("Data de conclus√£o (opcional)", cols_q, key="q_dt_conc")
    m_q["data_arquivado"] = sb("Data arquivado (opcional)", cols_q, key="q_dt_arch")
    m_q["total_cost"] = sb("Custo total ‚Ç¨ (opcional)", cols_q, key="q_total_cost")
    m_q["data_aprovacao"] = sb("Data de aprova√ß√£o (opcional)", cols_q, key="q_dt_aprov")

st.markdown("### Mapeamento de colunas (Itens) ‚Äî opcional")
cols_i = ["‚Äî"] + list(df_i.columns) if not df_i.empty else ["‚Äî"]
m_i = {}

c4, c5, c6 = st.columns(3)
with c4:
    m_i["quote_id"]       = sb("ID or√ßamento (liga√ß√£o, opcional)", cols_i, key="i_qid")
    m_i["quote_numero"]   = sb("N¬∫ or√ßamento (liga√ß√£o)", cols_i, key="i_qnum")
    m_i["tipo_item"]      = sb("Tipo (MATERIAL/SERVICO)", cols_i, key="i_tipo")
    m_i["code"]           = sb("C√≥digo do item", cols_i, key="i_code")
    m_i["categoria"]      = sb("Categoria", cols_i, key="i_cat")
with c5:
    m_i["unidade"]        = sb("Unidade (cm2/PC/min)", cols_i, key="i_uni")
    m_i["largura_cm"]     = sb("Largura (cm)", cols_i, key="i_larg")
    m_i["altura_cm"]      = sb("Altura (cm)", cols_i, key="i_alt")
    m_i["quantidade"]     = sb("Quantidade", cols_i, key="i_qtd")
with c6:
    m_i["preco_unit"]     = sb("Pre√ßo unit√°rio cliente ‚Ç¨", cols_i, key="i_preco")
    m_i["percent_uso"]    = sb("% uso", cols_i, key="i_uso")
    m_i["desconto_item"]  = sb("Desconto item ‚Ç¨", cols_i, key="i_desc")
    m_i["nome_pt"]        = sb("Nome PT (opcional)", cols_i, key="i_nomept")

st.caption("Se mapear **ID or√ßamento**, ele tem prioridade para ligar os itens; caso contr√°rio usamos o **N¬∫ or√ßamento**.")

st.markdown("### Op√ß√µes")
estado_default = st.selectbox("Estado padr√£o para importa√ß√£o", ["ARQUIVADO","ENTREGUE","REJEITADO","PAGO","ENVIADO","RASCUNHO"], index=0)
gerar_numero_se_faltar = st.toggle("Gerar n√∫mero de or√ßamento se n√£o vier no ficheiro", True)

st.markdown("---")
if st.button("üöÄ Importar para a BD"):
    imp_q = 0
    imp_i = 0
    dup_q = 0
    erros = []

    with get_session() as s:
        # cache de clientes por (numero, nome)
        cache_num = {}
        cache_nome = {}

        def get_or_create_client(num, nome):
            num_i = None
            if num is not None and str(num).strip():
                try:
                    num_i = int(str(num).strip())
                    if num_i in cache_num:
                        return cache_num[num_i]
                    c = s.exec(select(Client).where(Client.numero_cliente == num_i)).first()
                    if c:
                        cache_num[num_i] = c
                        cache_nome[getattr(c,"nome","").lower()] = c
                        return c
                except Exception:
                    num_i = None
            if nome and str(nome).strip():
                key = str(nome).strip().lower()
                if key in cache_nome:
                    return cache_nome[key]
                c = s.exec(select(Client).where(Client.nome == str(nome).strip())).first()
                if c:
                    cache_nome[key] = c
                    if getattr(c,"numero_cliente",None) is not None:
                        cache_num[int(c.numero_cliente)] = c
                    return c
                # criar novo
                c = Client(
                    numero_cliente = (num_i if num_i is not None else None),
                    nome = str(nome).strip(),
                    created_at = datetime.now(),
                    updated_at = datetime.now(),
                )
                # se n√£o tem n√∫mero, atribuir um novo
                if getattr(c, "numero_cliente", None) in (None, 0):
                    try:
                        mx = s.exec(select(Client).order_by(Client.numero_cliente.desc())).first()
                        c.numero_cliente = (getattr(mx, "numero_cliente", 0) or 0) + 1
                    except Exception:
                        c.numero_cliente = 1
                s.add(c); s.commit(); s.refresh(c)
                cache_nome[key] = c
                cache_num[int(c.numero_cliente)] = c
                return c
            return None

        # -------- Or√ßamentos --------
        for idx, row in df_q.iterrows():
            try:
                num = row.get(m_q["numero"], "") if m_q["numero"] != "‚Äî" else ""
                dt  = parse_date(row.get(m_q["data"], "")) if m_q["data"] != "‚Äî" else None
                cli_num = row.get(m_q["cliente_numero"], "") if m_q["cliente_numero"] != "‚Äî" else ""
                cli_nom = row.get(m_q["cliente_nome"], "") if m_q["cliente_nome"] != "‚Äî" else ""
                estado = row.get(m_q["estado"], "") if m_q["estado"] != "‚Äî" else estado_default
                lingua = (row.get(m_q["lingua"], "") if m_q["lingua"] != "‚Äî" else "PT") or "PT"
                desc   = row.get(m_q["descricao"], "") if m_q["descricao"] != "‚Äî" else ""
                obs    = row.get(m_q["observ"], "") if m_q["observ"] != "‚Äî" else ""
                desc_total = to_float(row.get(m_q["desconto_total"], 0)) if m_q["desconto_total"] != "‚Äî" else 0.0
                iva_pct    = to_float(row.get(m_q["iva_percent"], 0)) if m_q["iva_percent"] != "‚Äî" else 0.0
                entrega    = parse_date(row.get(m_q["data_entrega"], "")) if m_q["data_entrega"] != "‚Äî" else None
                total_fin  = to_float(row.get(m_q["total_final"], 0)) if m_q["total_final"] != "‚Äî" else None

                # opcionais extra
                tot_mat  = to_float(row.get(m_q.get("total_mat_cost","‚Äî"), 0)) if m_q.get("total_mat_cost","‚Äî") != "‚Äî" else None
                tot_srv  = to_float(row.get(m_q.get("total_srv_cost","‚Äî"), 0)) if m_q.get("total_srv_cost","‚Äî") != "‚Äî" else None
                profit_v = to_float(row.get(m_q.get("profit","‚Äî"), 0)) if m_q.get("profit","‚Äî") != "‚Äî" else None
                exp_pct  = to_float(row.get(m_q.get("expense_pct","‚Äî"), 0)) if m_q.get("expense_pct","‚Äî") != "‚Äî" else None
                dt_conc  = parse_date(row.get(m_q.get("data_conclusao","‚Äî"), "")) if m_q.get("data_conclusao","‚Äî") != "‚Äî" else None
                dt_arch  = parse_date(row.get(m_q.get("data_arquivado","‚Äî"), "")) if m_q.get("data_arquivado","‚Äî") != "‚Äî" else None
                dt_aprov = parse_date(row.get(m_q.get("data_aprovacao","‚Äî"), "")) if m_q.get("data_aprovacao","‚Äî") != "‚Äî" else None
                tot_cost = to_float(row.get(m_q.get("total_cost","‚Äî"), 0)) if m_q.get("total_cost","‚Äî") != "‚Äî" else None
                # aprova√ß√£o (SIM/N√ÉO)
                aprov_raw = row.get(m_q.get("aprovacao","‚Äî"), "") if m_q.get("aprovacao","‚Äî") != "‚Äî" else ""
                def _parse_aprov(v):
                    s = str(v or "").strip().upper()
                    if s in ("SIM","YES","Y","TRUE","1","APROVADO","OK"): return True
                    if s in ("NAO","N√ÉO","NO","N","FALSE","0","REJEITADO"): return False
                    return None
                aprov_val = _parse_aprov(aprov_raw)

                # cliente
                cli = get_or_create_client(cli_num, cli_nom)
                if not cli:
                    erros.append(f"Linha {idx+1}: sem cliente (n√∫mero/nome).")
                    continue

                # n√∫mero do or√ßamento (respeitar n√∫mero do ficheiro mas com prefixo do ano ‚Üí YY####)
                numero_ok = ""
                raw_num = str(num).strip()
                if raw_num:
                    numero_ok = normalize_num_with_year(raw_num, dt, entrega)
                # se ainda vazio e a op√ß√£o permitir, gerar sequencial do ano atual
                if not numero_ok and gerar_numero_se_faltar:
                    yy = datetime.utcnow().strftime("%y")
                    existentes = s.exec(select(Quote).where(Quote.numero.like(f"{yy}%"))).all()
                    seq = 0
                    if existentes:
                        try:
                            seq = max([int(str(q.numero)[2:]) for q in existentes if getattr(q, 'numero', None) and len(str(q.numero)) >= 6])
                        except Exception:
                            seq = 0
                    numero_ok = f"{yy}{seq+1:04d}"

                # duplicado?
                if numero_ok:
                    dup = s.exec(select(Quote).where(Quote.numero == numero_ok)).first()
                    if dup:
                        dup_q += 1
                        continue

                q = Quote(
                    numero = numero_ok if numero_ok else None,
                    cliente_id = cli.id,
                    lingua = lingua,
                    descricao = desc,
                    desconto_total = desc_total,
                    iva_percent = iva_pct,
                    data_criacao = dt or datetime.utcnow(),
                    data_entrega_prevista = entrega,
                    estado = estado or estado_default,
                    observacoes = obs if hasattr(Quote, "observacoes") else None,
                )
                # se o teu modelo tiver 'total' e forneceste:
                if hasattr(Quote, "total") and total_fin is not None:
                    setattr(q, "total", total_fin)

                s.add(q); s.commit(); s.refresh(q)

                # aplicar campos opcionais mapeados, apenas se o modelo tiver esses atributos
                changed = False
                try:
                    if total_fin is not None and hasattr(q, "final_total_eur"):
                        setattr(q, "final_total_eur", float(total_fin))
                        changed = True
                except Exception:
                    pass
                try:
                    if tot_mat is not None and hasattr(q, "total_material_cost_eur"):
                        setattr(q, "total_material_cost_eur", float(tot_mat))
                        changed = True
                except Exception:
                    pass
                try:
                    if tot_srv is not None and hasattr(q, "total_service_cost_eur"):
                        setattr(q, "total_service_cost_eur", float(tot_srv))
                        changed = True
                except Exception:
                    pass
                try:
                    if profit_v is not None and hasattr(q, "profit_eur"):
                        setattr(q, "profit_eur", float(profit_v))
                        changed = True
                except Exception:
                    pass
                try:
                    if exp_pct is not None and hasattr(q, "expense_percent"):
                        setattr(q, "expense_percent", float(exp_pct))
                        changed = True
                except Exception:
                    pass
                # datas opcionais
                try:
                    if dt_conc and (hasattr(q, "data_conclusao") or hasattr(q, "concluded_at")):
                        if hasattr(q, "data_conclusao"):
                            setattr(q, "data_conclusao", dt_conc)
                        elif hasattr(q, "concluded_at"):
                            setattr(q, "concluded_at", dt_conc)
                        changed = True
                except Exception:
                    pass
                try:
                    if dt_arch and (hasattr(q, "archived_at") or hasattr(q, "data_arquivado")):
                        if hasattr(q, "archived_at"):
                            setattr(q, "archived_at", dt_arch)
                        elif hasattr(q, "data_arquivado"):
                            setattr(q, "data_arquivado", dt_arch)
                        changed = True
                except Exception:
                    pass
                try:
                    if tot_cost is not None and hasattr(q, "total_cost_eur"):
                        setattr(q, "total_cost_eur", float(tot_cost))
                        changed = True
                except Exception:
                    pass
                try:
                    if aprov_val is not None:
                        if hasattr(q, "aprovado"):
                            setattr(q, "aprovado", bool(aprov_val)); changed = True
                        elif hasattr(q, "foi_aprovado"):
                            setattr(q, "foi_aprovado", bool(aprov_val)); changed = True
                        elif hasattr(q, "status"):
                            setattr(q, "status", "APROVADO" if aprov_val else "REJEITADO"); changed = True
                except Exception:
                    pass
                try:
                    if dt_aprov and hasattr(q, "approved_at"):
                        setattr(q, "approved_at", dt_aprov)
                        changed = True
                    elif (aprov_val is True) and hasattr(q, "approved_at") and getattr(q, "approved_at", None) is None:
                        # Se marcado como aprovado mas sem data, usar a data do or√ßamento ou agora
                        setattr(q, "approved_at", dt or datetime.utcnow())
                        changed = True
                except Exception:
                    pass
                if changed:
                    s.add(q); s.commit(); s.refresh(q)

                imp_q += 1
            except Exception as e:
                erros.append(f"Linha {idx+1} (or√ßamento): {e}")

        # -------- Itens (opcional) --------
        if not df_i.empty and imp_q > 0:
            # criar √≠ndices por ID e por n√∫mero
            all_quotes = s.exec(select(Quote)).all()
            quotes_by_id = {int(q.id): q for q in all_quotes if getattr(q, 'id', None) is not None}
            quotes_by_num = {str(q.numero).strip(): q for q in all_quotes if getattr(q, 'numero', None)}
            # mapa por sufixo de 4 d√≠gitos (para itens antigos que s√≥ trazem 1..82)
            suffix_map = {}
            for q in all_quotes:
                num = str(getattr(q, 'numero', '') or '').strip()
                if len(num) >= 6 and num.isdigit():
                    suffix = num[-4:]
                    suffix_map.setdefault(suffix, []).append(q)

            for idx, row in df_i.iterrows():
                try:
                    # 1) Tentar por ID interno
                    q = None
                    if m_i.get("quote_id") and m_i["quote_id"] != "‚Äî":
                        raw_id = row.get(m_i["quote_id"], "")
                        try:
                            qid = int(str(raw_id).strip())
                            q = quotes_by_id.get(qid)
                        except Exception:
                            q = None

                    # 2) Fallback: tentar por n√∫mero
                    if q is None:
                        qnum = row.get(m_i.get("quote_numero", "‚Äî"), "") if m_i.get("quote_numero", "‚Äî") != "‚Äî" else ""
                        raw = str(qnum).strip()
                        if raw:
                            # manter tentativa direta primeiro
                            q = quotes_by_num.get(raw)
                            if q is None:
                                # limpar s√≥ d√≠gitos
                                digits = ''.join(ch for ch in raw if ch.isdigit())
                                if len(digits) == 6 and digits in quotes_by_num:
                                    q = quotes_by_num.get(digits)
                                elif 1 <= len(digits) <= 4:
                                    suf = digits.zfill(4)
                                    candidates = suffix_map.get(suf, [])
                                    if len(candidates) == 1:
                                        q = candidates[0]
                    if q is None:
                        continue

                    tipo = str(row.get(m_i["tipo_item"], "MATERIAL")).upper() if m_i["tipo_item"] != "‚Äî" else "MATERIAL"
                    code = row.get(m_i["code"], "") if m_i["code"] != "‚Äî" else ""
                    cat  = row.get(m_i["categoria"], "") if m_i["categoria"] != "‚Äî" else ""
                    uni  = row.get(m_i["unidade"], "") if m_i["unidade"] != "‚Äî" else "PC"
                    larg = to_float(row.get(m_i["largura_cm"], 0)) if m_i["largura_cm"] != "‚Äî" else 0.0
                    alt  = to_float(row.get(m_i["altura_cm"], 0)) if m_i["altura_cm"] != "‚Äî" else 0.0
                    qtd  = to_float(row.get(m_i["quantidade"], 1)) if m_i["quantidade"] != "‚Äî" else 1.0
                    pvu  = to_float(row.get(m_i["preco_unit"], 0)) if m_i["preco_unit"] != "‚Äî" else 0.0
                    uso  = to_float(row.get(m_i["percent_uso"], 100)) if m_i["percent_uso"] != "‚Äî" else 100.0
                    dsc  = to_float(row.get(m_i["desconto_item"], 0)) if m_i["desconto_item"] != "‚Äî" else 0.0
                    nome_pt = row.get(m_i["nome_pt"], "") if m_i["nome_pt"] != "‚Äî" else ""

                    qi = QuoteItem(
                        quote_id = q.id,
                        categoria_item = cat,
                        tipo_item = tipo,
                        ref_id = None,
                        code = code,
                        nome_pt = nome_pt,
                        nome_en = None,
                        nome_fr = None,
                        unidade = uni,
                        largura_cm = larg,
                        altura_cm = alt,
                        quantidade = qtd,
                        preco_unitario_cliente = pvu,
                        percent_uso = uso,
                        desconto_item = dsc,
                    )
                    s.add(qi); s.commit()
                    imp_i += 1
                except Exception as e:
                    erros.append(f"Linha {idx+1} (item): {e}")

    st.success(f"Importa√ß√£o conclu√≠da: {imp_q} or√ßamentos, {imp_i} itens. Duplicados ignorados: {dup_q}.")
    if erros:
        with st.expander("Ver registos com erro"):
            for e in erros[:200]:
                st.write("‚Ä¢", e)